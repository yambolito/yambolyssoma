<!DOCTYPE html>
<html>
<head>
  <title>Indicadores de Seguridad y Salud en el Trabajo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    function calcularIndicadores() {
      var accidentes = parseInt(document.getElementById("accidentes").value);
      var incidentes = parseInt(document.getElementById("incidentes").value);

      var indiceFrecuencia = accidentes / 1000;
      var indiceGravedad = (accidentes + incidentes) / 1000;

      document.getElementById("indiceFrecuencia").textContent = indiceFrecuencia.toFixed(2);
      document.getElementById("indiceGravedad").textContent = indiceGravedad.toFixed(2);

      mostrarGrafico(indiceFrecuencia, indiceGravedad);
    }

    function guardarInformacion() {
      var accidentes = parseInt(document.getElementById("accidentes").value);
      var incidentes = parseInt(document.getElementById("incidentes").value);

      var datos = {
        accidentes: accidentes,
        incidentes: incidentes
      };

      localStorage.setItem("datosSeguridad", JSON.stringify(datos));
      alert("Información guardada correctamente.");
    }

    function mostrarInformacionGuardada() {
      var datos = JSON.parse(localStorage.getItem("datosSeguridad"));

      if (datos) {
        document.getElementById("accidentes").value = datos.accidentes;
        document.getElementById("incidentes").value = datos.incidentes;
        calcularIndicadores();
      }
    }

    function mostrarGrafico(indiceFrecuencia, indiceGravedad) {
      var ctx = document.getElementById("grafico").getContext("2d");
      var data = {
        labels: ["Índice de Frecuencia", "Índice de Gravedad"],
        datasets: [
          {
            label: "Indicadores",
            data: [indiceFrecuencia, indiceGravedad],
            backgroundColor: ["rgba(75, 192, 192, 0.2)", "rgba(255, 99, 132, 0.2)"],
            borderColor: ["rgba(75, 192, 192, 1)", "rgba(255, 99, 132, 1)"],
            borderWidth: 1
          }
        ]
      };

      var options = {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      };

      new Chart(ctx, {
        type: "bar",
        data: data,
        options: options
      });
    }

    function descargarExcel() {
      var datos = JSON.parse(localStorage.getItem("datosSeguridad"));

      if (datos) {
        var workbook = XLSX.utils.book_new();
        var worksheet = XLSX.utils.json_to_sheet([datos]);

        var canvas = document.getElementById("grafico");
        var dataURL = canvas.toDataURL("image/jpeg");
        var img = new Image();
        img.src = dataURL;

        var ctx = XLSX.utils.sheet_add_image(worksheet, img, {
          tl: { col: 2, row: 1 },
          ext: { width: canvas.width, height: canvas.height }
        });

        XLSX.utils.book_append_sheet(workbook, worksheet, "Indicadores");

        var fecha = new Date().toISOString().slice(0, 10);
        var nombreArchivo = "indicadores_" + fecha + ".xlsx";
        
        var blob = new Blob([XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' })], { type: 'application/octet-stream' });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.href = url;
        link.download = nombreArchivo;
        link.click();
      } else {
        alert("No se encontraron datos para generar el archivo Excel.");
      }
    }
  </script>
</head>
<body>
  <h1>Indicadores de Seguridad y Salud en el Trabajo</h1>

  <form>
    <label for="accidentes">Cantidad de accidentes:</label>
    <input type="number" id="accidentes">

    <label for="incidentes">Cantidad de incidentes:</label>
    <input type="number" id="incidentes">

    <button type="button" onclick="calcularIndicadores()">Calcular</button>
    <br><br>

    <label>Indicadores:</label>
    <ul>
      <li>Índice de Frecuencia: <span id="indiceFrecuencia"></span></li>
      <li>Índice de Gravedad: <span id="indiceGravedad"></span></li>
    </ul>

    <canvas id="grafico" width="400" height="200"></canvas>

    <button type="button" onclick="guardarInformacion()">Guardar Información</button>
    <button type="button" onclick="mostrarInformacionGuardada()">Mostrar Información Guardada</button>
    <button type="button" onclick="descargarExcel()">Descargar Excel</button>
  </form>
</body>
</html>